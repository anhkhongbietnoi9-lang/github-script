-- Khởi tạo ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MC_walhop"
screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

-- Hàm tạo Bo Góc (UICorner)
local function addCorner(parent, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius)
    corner.Parent = parent
end

-- Hàm tạo Viền Rainbow (UIStroke)
local function addRainbowStroke(parent)
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Parent = parent
    
    -- Hiệu ứng đổi màu cầu vồng
    spawn(function()
        local counter = 0
        while wait() do
            stroke.Color = Color3.fromHSV(counter, 1, 1)
            counter = counter + 0.01
            if counter >= 1 then counter = 0 end
        end
    end)
end

-- Main Frame (Phông nền đen, bo góc, viền cầu vồng)
local frame = Instance.new("Frame")
frame.Name = "MainFrame"
frame.Parent = screenGui
frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15) -- Đen xám sang trọng
frame.Size = UDim2.new(0, 200, 0, 120)
frame.Position = UDim2.new(0.5, -100, 0.5, -60)
frame.Active = true
frame.Draggable = true -- Cho phép kéo thả

addCorner(frame, 10)
addRainbowStroke(frame)

-- Title Label (Tiêu đề)
local titleLabel = Instance.new("TextLabel")
titleLabel.Parent = frame
titleLabel.BackgroundTransparency = 1
titleLabel.Size = UDim2.new(1, 0, 0, 30)
titleLabel.Text = "MC WALHOP"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.TextScaled = false

-- Status Label (Hiển thị trạng thái On/Off)
local statusLabel = Instance.new("TextLabel")
statusLabel.Parent = frame
statusLabel.BackgroundTransparency = 1
statusLabel.Position = UDim2.new(0, 0, 0, 30)
statusLabel.Size = UDim2.new(1, 0, 0, 20)
statusLabel.Text = "Status: OFF"
statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12

-- Toggle Button (Nút On/Off tích hợp)
local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Parent = frame
toggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
toggleButton.Position = UDim2.new(0.1, 0, 0.55, 0)
toggleButton.Size = UDim2.new(0.8, 0, 0, 35)
toggleButton.Text = "ENABLE"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.Font = Enum.Font.GothamBold
toggleButton.AutoButtonColor = true

addCorner(toggleButton, 8)
addRainbowStroke(toggleButton)

---------------------------------------------------------
-- LOGIC WALLHOP (Giữ nguyên từ kế hoạch của bạn)
---------------------------------------------------------

local toggle = false
local InfiniteJumpEnabled = true
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

local raycastParams = RaycastParams.new()
raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

local function getWallRaycastResult()
    local player = Players.LocalPlayer
    local character = player.Character
    if not character then return nil end
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil end

    raycastParams.FilterDescendantsInstances = {character}

    local directions = {
        humanoidRootPart.CFrame.LookVector,
        -humanoidRootPart.CFrame.LookVector,
        humanoidRootPart.CFrame.RightVector,
        -humanoidRootPart.CFrame.RightVector
    }
    local detectionDistance = 2
    local closestHit = nil
    local minDistance = detectionDistance + 1

    for _, direction in pairs(directions) do
        local ray = Workspace:Raycast(humanoidRootPart.Position, direction * detectionDistance, raycastParams)
        if ray and ray.Instance then
             if ray.Distance < minDistance then
                 minDistance = ray.Distance
                 closestHit = ray
             end
        end
    end
    return closestHit
end

-- Xử lý nút On/Off
toggleButton.MouseButton1Click:Connect(function()
    toggle = not toggle
    if toggle then
        toggleButton.Text = "on"
        statusLabel.Text = "Status: ON"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    else
        toggleButton.Text = "off"
        statusLabel.Text = "Status: OFF"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
    end
end)

-- Xử lý Wallhop
UserInputService.JumpRequest:Connect(function()
    if not toggle or not InfiniteJumpEnabled then return end

    local player = Players.LocalPlayer
    local character = player.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local camera = Workspace.CurrentCamera

    if not (humanoid and rootPart and camera) then return end

    local wallRayResult = getWallRaycastResult()

    if wallRayResult then
        InfiniteJumpEnabled = false 

        local wallNormal = wallRayResult.Normal
        local horizontalWallNormal = Vector3.new(wallNormal.X, 0, wallNormal.Z).Unit
        if horizontalWallNormal.Magnitude < 0.1 then
             horizontalWallNormal = (rootPart.CFrame.LookVector * Vector3.new(1,0,1)).Unit
             if horizontalWallNormal.Magnitude < 0.1 then horizontalWallNormal = Vector3.new(0,0,-1) end
        end
        local baseDirectionAwayFromWall = horizontalWallNormal 

        local cameraLook = camera.CFrame.LookVector
        local horizontalCameraLook = Vector3.new(cameraLook.X, 0, cameraLook.Z).Unit
        
        local maxInfluenceAngle = math.rad(40)
        local dot = math.clamp(baseDirectionAwayFromWall:Dot(horizontalCameraLook), -1, 1)
        local angleBetween = math.acos(dot)
        local cross = baseDirectionAwayFromWall:Cross(horizontalCameraLook)
        local rotationSign = math.sign(cross.Y)
        if rotationSign == 0 then angleBetween = 0 end
        local actualInfluenceAngle = math.min(angleBetween, maxInfluenceAngle)
        local adjustmentRotation = CFrame.Angles(0, actualInfluenceAngle * rotationSign, 0)
        local initialTargetLookDirection = adjustmentRotation * baseDirectionAwayFromWall

        rootPart.CFrame = CFrame.lookAt(rootPart.Position, rootPart.Position + initialTargetLookDirection)

        RunService.Heartbeat:Wait()

        if humanoid and humanoid:GetState() ~= Enum.HumanoidStateType.Dead then
             humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
             local directionTowardsWall = -baseDirectionAwayFromWall 
             rootPart.CFrame = CFrame.lookAt(rootPart.Position, rootPart.Position + directionTowardsWall)
        end

        task.wait(0.15)
        InfiniteJumpEnabled = true 
    end
end)
